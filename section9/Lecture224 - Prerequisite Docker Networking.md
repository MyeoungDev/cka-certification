# Lecture 224 - Prerequisite Docker Networking

- 예시: 호스트 == 집, 네임스페이스 == 방
- 각 방(네임스페이스)은 사용자(컨테이너) 를 격리하여 프로세스와 네트워크 인터페이스의 브라이버시 보장.
- 컨테이너는 자체 네임스페이스 내의 프로세스만 확인 가능.
- 호스트는 모든 네임스페이스를 관리하고 필요 시 네임스페이스 간 통신을 연결 할 수 있다.
- 컨테이너가 생성되면 자체 네트워크 네임스페이스에 배치된다.
- 이 네임스페이스 내에서 컨테이너는 자신의 프로세스만 볼 수 있습니다.
- 컨테이너 내부에서 `ps` 명령어를 통한 것과 호스트에서 실행의 결과는 다르다.
- 개수는 호스트가 더 많을 것이며, 동일한 프로세스가 다른 PID 로 나타난다.
- 이러한 동작은 네임스페이스가 컨테이너 프로세스를 호스트의 프로세스 공간에서 어떻게 분리하는지 나타낸다.

## 네트워크 격리

- 호스트는 자체 인터페이스, ARP 테이블, 라우팅 구성을 유지하며, 이 모든 정보를 컨테이너에 공개하지 않는다.
- 컨테이너가 생성되면 전용 네트워크 네임스페이스가 해당 컨테이너에 자체 가상 네임스페이스, 라우팅 테이블, ARP 캐시를 제공한다.
- 즉, 각 컨에티너가 자신만의 독립된 IP 주소와 포트 공간을 갖는 것이 네트워크 네임스페이스 덕북이다.
- 네트워크 네임스페이스
    - 리눅스 커널이 제공하는 기능으로, 하나의 시스템 안에 여러 개의 독립적인 네트워크 환견 구성 가능.
    - 각 네임스페이스는 자신만의 네트워크 인터페이스(IP 주소), 라우팅 테이블 ARP 테이블을 가진다.
    - 기본적으로 생성하면 외부와 완전히 단절된, 루프백 인터페이스(lo)만 존재하는 폐쇄된 공간이 된다.
    - 호스트(기본 시스템)의 네트워크 인터페이스(eth0 등)는 이 공간 안에서 보이지 않는다.
    - 명령어
        - ip netns list: 생성된 모든 네임스페이스 목록.
        - ip netns add <이름>: 새로운 네임스페이스를 생성. (예: ip netns add red)
        - ip netns exec <이름> <명령어>: 특정 네임스페이스 안에서 명령어를 실행 (예: ip netns exec red ip link)
- `veth` 쌍 (가상 랜선)
    - 격리된 두 개의 방(네임스페이스)를 연결하려면 '선' 이 필요하다.
    - 이 역할을 하는 것이 가상 이더넷(`veth`) 쌍이다.
    - `veth` 는 터널처럼 양 끝이 이쓴 한 쌍의 가상 네트워크 인터페이스 이다.
    - 한쪽 끝으로 들어간 패킷은 반드시 다른 쪽 끝으로 나온다.
    - 연결 과정
        - `veth` 쌍 생성
            - 가상 랜선 한 묶을 생성 (`ip link add veth-red type veth peer name veth-blue`)
        - 각 네임스페이스에 할당
            - 각 양 끝 `veth-red`, `veth-blue` 를 각 네임스페이스에 할당 (`ip link set veth-red netns red`)
        - IP 주소 할당 및 활성화
            - 각 방 안에서 자신의 랜선 끝에 IP 주소를 할당하고, 인터페이스를 활성화(`up`) (`ip -n red addr add 192.168.15.1/24 dev veth-red`)
        - 연결 확인
            - `ping`, `dig` 등을 통해 한쪽 네임스페이스에서 연결한 네임스페이스로 통신 확인.
- 가상 스위치 (bridge)
    - 여러 개의 네임스페이가 있을 때, 각각을 하나씩 연결하는 것은 비효율적이다.
    - 이때 필요한 것이 가상 스위치 (Linux Bridge) 이다.
    - 여러 네트워크 인터페이스를 하나로 묶어주는 소프트웨어 기반의 레이어 2 스위치이다.
    - 여기에 연결된 모든 인터페이스는 서로 통신 할 수 있다.
    - 연결 과정
        - 가상 스위치(Bridge) 생성. (`ip link v-net-0 type bridge`)
        - 스위치 활성화 (`ip link set v-net-0 up`)
        - 각 네임스페이스 마다 스위치에 연결할 새로운 `veth` 쌍 생성 (`ip link add veth-red type veth peer name veth-red-br`)
        - `veth` 쌍 연결
        - 각 네임스페이스 안에서 인터페이스에 IP 를 할당하고 활성화.
        - 호스트와 브리지 연결
            - 호스트가 해당 가상 네트워크에 참여하고 통신할 수 있또록 가상 스위치 자체에 네임스페이스와 동일한 대역의 IP 주소 할당

```bash
# Red 네임스페이스 연결
ip link set veth-red netns red
ip link set veth-red-br master v-net-0

# Blue 네임스페이스 연결
ip link set veth-blue netns blue
ip link set veth-blue-br master v-net-0

ip -n red addr add 192.168.15.1/24 dev veth-red
ip -n blue addr add 192.168.15.2/24 dev veth-blue

ip -n red link set veth-red up
ip -n blue link set veth-blue up

```

## 외부 연결 활성화

- 네임스페이스와 브리지로 생성된 내부 네트워크는 외부 네트워크와 분리된다.
- 호스트의 외부 인터페이스가 LAN 서브넷(192.168.1.0/24) 을 사용하고 네임스페이스를 통해 외부 시스템과 통신하려는 경우를 가정.
- 파란색 네임스페이스에서 외부 호스트 (192.168.1.3)에 `ping` 을 보내면 네트워크 연결 실패 오류 발생.
    - `ip netns exec blue ping 192.168.1.3`
- 파란색 네임스페이스가 외부 네트워크에 접속할 수 있게 라우트 경로 추가
- 브리지의 호스트 IP(192.168.15.5) 를 통해 192.168.1.0/24 로 향하는 트래픽 전달 경로 추가
    - `ip netns exec blue ip route add 192.168.1.0/24 via 192.168.15.5`
- 이제 파란색 네임스페이스가 외부 네트워크에 접속 가능.
- 그러나 외부 네트워크는 개인 IP 주소를 인식 불가.
- 이 문제를 해결하기 위해서는 `iptables` 를 사용하여 호스트에 `NAT` 를 구성해야 한다.

## 인바운드 액세스 활성화

- 지금까지 네임스페이스는 내부 네트워크에서 격리되어 외부 호스트에서 직접 접근하는 것이 불가능했다.
- 이를 위한 두 가지 해결책이 있다.
- 외부 라우터나 호스트에 정적 경로를 추가하여 192.168.15.0/24 네트워크의 트래픽이 호스트의 LAN IP(예: 192.168.1.2)를 통해 전달되도록 한다.
- 호스트의 iptables를 통한 포트 포워딩을 사용하여 특정 포트(예: 포트 80)에 도착하는 트래픽을 네임스페이스의 해당 포트로 리디렉션
    - 포트 포워딩 방식은 외부 라우팅을 재구성할 필요성을 없애므로 선호된다.